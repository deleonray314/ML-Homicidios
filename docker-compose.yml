services:
  # ============================================================================
  # Data Lake - PostgreSQL
  # Base de datos para almacenar datos crudos con mínimas transformaciones
  # ============================================================================
  datalake:
    image: postgres:15-alpine
    container_name: ml-homicidios-datalake
    restart: unless-stopped

    # Port mapping para acceso desde localhost (desarrollo/testing)
    ports:
      - "5433:5432"

    environment:
      POSTGRES_USER: ${DATALAKE_USER:-datalake_user}
      POSTGRES_PASSWORD: ${DATALAKE_PASSWORD:-datalake_password}
      POSTGRES_DB: ${DATALAKE_DB:-homicidios_datalake}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=es_CO.UTF-8"

    volumes:
      - datalake_data:/var/lib/postgresql/data
      - ./docker/init-scripts/01-create-datalake-schema.sql:/docker-entrypoint-initdb.d/01-create-schema.sql

    networks:
      - ml-homicidios-network

    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${DATALAKE_USER:-datalake_user}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # Data Warehouse - PostgreSQL
  # Base de datos para el modelo estrella (fact + dimensions)
  # ============================================================================
  datawarehouse:
    ports:
      - "5434:5432"
    image: postgres:15-alpine
    container_name: ml-homicidios-datawarehouse
    restart: unless-stopped

    environment:
      POSTGRES_USER: ${DW_USER:-dw_user}
      POSTGRES_PASSWORD: ${DW_PASSWORD:-dw_password}
      POSTGRES_DB: ${DW_DB:-homicidios_dw}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=es_CO.UTF-8"

    volumes:
      - datawarehouse_data:/var/lib/postgresql/data
      - ./docker/init-scripts/02-create-datawarehouse-schema.sql:/docker-entrypoint-initdb.d/02-create-schema.sql

    networks:
      - ml-homicidios-network

    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${DW_USER:-dw_user}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # Adminer - Interfaz web ligera para administrar las bases de datos
  # ============================================================================
  adminer:
    image: adminer:latest
    container_name: ml-homicidios-adminer
    restart: unless-stopped

    ports:
      - "8080:8080"

    environment:
      ADMINER_DEFAULT_SERVER: datalake
      ADMINER_DESIGN: pepa-linha

    networks:
      - ml-homicidios-network

    depends_on:
      - datalake
      - datawarehouse

  # ============================================
  # Servicio ETL con Cron
  # ============================================
  etl-cron:
    build:
      context: .
      dockerfile: docker/Dockerfile.etl
    container_name: ml-homicidios-etl-cron
    restart: unless-stopped

    environment:
      - TZ=America/Bogota
      - PYTHONUNBUFFERED=1

    volumes:
      # Logs persistentes
      - ./logs:/app/logs
      # Código fuente (para desarrollo - hot reload)
      - ./src:/app/src:ro
      - ./scripts:/app/scripts:ro
      # Configuración
      - ./.env:/app/.env:ro

    networks:
      - ml-homicidios-network

    depends_on:
      datalake:
        condition: service_healthy
      datawarehouse:
        condition: service_healthy

    healthcheck:
      test: [ "CMD", "pgrep", "crond" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ==============================================================================
# Volumes - Persistencia de datos
# ==============================================================================
volumes:
  datalake_data:
    name: ml-homicidios-datalake-data
  datawarehouse_data:
    name: ml-homicidios-datawarehouse-data

# ==============================================================================
# Networks - Red interna para comunicación entre servicios
# ==============================================================================
networks:
  ml-homicidios-network:
    name: ml-homicidios-network
    driver: bridge
